<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>استبيان رضا المستفيد</title>

  <style>
    :root{
      --bg:#0b1220; --card:#0f1b2d; --text:#e7eefc; --muted:#a9b6d3;
      --line:rgba(255,255,255,.10); --input:rgba(255,255,255,.06); --input2:rgba(255,255,255,.09);
      --accent:#6eceeb; --star-off:#5b6b8b; --star-on:#ffd45a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",Tahoma,Arial,sans-serif;
      background:
        radial-gradient(1200px 600px at 70% 10%, rgba(110,206,235,.12), transparent 60%),
        radial-gradient(900px 500px at 20% 90%, rgba(85,188,217,.10), transparent 60%),
        var(--bg);
      color:var(--text);
    }
    .wrap{max-width:820px;margin:32px auto;padding:0 16px}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:16px;
      padding:22px;
      box-shadow:0 18px 40px rgba(0,0,0,.30);
    }
    .header h1{margin:0 0 8px;font-size:22px;line-height:1.35}
    .muted{color:var(--muted)}
    .header p{margin:0}
    .divider{height:1px;background:var(--line);margin:18px 0}
    .field{margin:14px 0}
    .label{display:block;margin-bottom:8px;font-weight:600}

    select, textarea{
      width:100%;
      border-radius:12px;
      border:1px solid var(--line);
      background:var(--input);
      color:var(--text);
      padding:12px 12px;
      outline:none;
      transition:border .15s ease, background .15s ease;
    }
    select:focus, textarea:focus{
      border-color:rgba(110,206,235,.45);
      background:var(--input2);
    }
    .hint{display:block;margin-top:8px;color:var(--muted);font-size:12px}

    .q{padding:14px 0;border-bottom:1px solid var(--line)}
    .q:last-of-type{border-bottom:0}
    .q-head{
      display:flex;gap:12px;align-items:baseline;justify-content:space-between;margin-bottom:10px
    }
    .q-head h3{margin:0;font-size:15.5px;font-weight:650;line-height:1.5}
    .q-meta{color:var(--muted);font-size:12px;white-space:nowrap}

    .rating{
      display:inline-flex;
      flex-direction:row-reverse;
      gap:8px;
      user-select:none;
    }
    .rating input{
      position:absolute;opacity:0;width:1px;height:1px;
    }
    .rating label{
      font-size:34px;line-height:1;
      cursor:pointer;
      color:var(--star-off);
      filter:drop-shadow(0 8px 10px rgba(0,0,0,.25));
      transition:transform .08s ease, color .12s ease;
    }
    .rating label:hover{transform:translateY(-1px) scale(1.02)}
    .rating label:hover,
    .rating label:hover ~ label{color:var(--star-on)}
    .rating input:checked ~ label{color:var(--star-on)}
    .rating input:focus-visible + label{
      outline:2px solid rgba(110,206,235,.65);
      outline-offset:4px;
      border-radius:10px;
    }

    .actions{display:flex;gap:10px;margin-top:16px;flex-wrap:wrap}
    .btn{
      border:1px solid var(--line);
      background:var(--input);
      color:var(--text);
      padding:11px 14px;
      border-radius:12px;
      cursor:pointer;
      transition:transform .06s ease, background .15s ease, border .15s ease;
    }
    .btn:hover{background:var(--input2)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{
      border-color:rgba(110,206,235,.35);
      background:linear-gradient(180deg, rgba(110,206,235,.18), rgba(110,206,235,.10));
    }
    .btn.primary:hover{border-color:rgba(110,206,235,.55)}
    .foot{margin:14px 0 0;font-size:12px}

    .hidden{display:none !important}
    .done-actions{display:flex;gap:10px;margin-top:14px;flex-wrap:wrap}
    .json{
      margin-top:14px;padding:14px;border-radius:12px;border:1px solid var(--line);
      background:rgba(0,0,0,.22);overflow:auto;max-height:320px;
      direction:ltr;text-align:left;font-size:12px;
    }
  </style>
</head>

<body>
  <main class="wrap">
    <section class="card" id="formCard">
      <header class="header">
        <h1>استبيان رضا عام عن تجربة المستفيد مع المؤسسة</h1>
        <p class="muted">قيّم التجربة بالنجوم، ويمكنك إضافة ملاحظاتك في النهاية.</p>
      </header>

      <form id="surveyForm" novalidate>
        <div class="field">
          <label for="serviceType" class="label">نوع الخدمة</label>
          <select id="serviceType" name="service_type" required>
            <option value="" selected disabled>اختر نوع الخدمة</option>
            <option value="تأهيل">تأهيل</option>
            <option value="توظيف">توظيف</option>
            <option value="متابعة">متابعة</option>
            <option value="استشارة">استشارة</option>
          </select>
          <small class="hint">اختيار واحد فقط.</small>
        </div>

        <div class="divider"></div>

        <div class="q">
          <div class="q-head">
            <h3>كانت الخدمات واضحة ومفهومة بالنسبة لي.</h3>
            <span class="q-meta" data-live-for="q1">لم يتم التقييم</span>
          </div>
          <div class="rating" aria-label="تقييم السؤال الأول">
            <input type="radio" id="q1-5" name="q1" value="5" required><label for="q1-5" title="5 نجوم">★</label>
            <input type="radio" id="q1-4" name="q1" value="4"><label for="q1-4" title="4 نجوم">★</label>
            <input type="radio" id="q1-3" name="q1" value="3"><label for="q1-3" title="3 نجوم">★</label>
            <input type="radio" id="q1-2" name="q1" value="2"><label for="q1-2" title="نجمتين">★</label>
            <input type="radio" id="q1-1" name="q1" value="1"><label for="q1-1" title="نجمة">★</label>
          </div>
        </div>

        <div class="q">
          <div class="q-head">
            <h3>كانت إجراءات المؤسسة سهلة والتواصل واضح.</h3>
            <span class="q-meta" data-live-for="q2">لم يتم التقييم</span>
          </div>
          <div class="rating" aria-label="تقييم السؤال الثاني">
            <input type="radio" id="q2-5" name="q2" value="5" required><label for="q2-5" title="5 نجوم">★</label>
            <input type="radio" id="q2-4" name="q2" value="4"><label for="q2-4" title="4 نجوم">★</label>
            <input type="radio" id="q2-3" name="q2" value="3"><label for="q2-3" title="3 نجوم">★</label>
            <input type="radio" id="q2-2" name="q2" value="2"><label for="q2-2" title="نجمتين">★</label>
            <input type="radio" id="q2-1" name="q2" value="1"><label for="q2-1" title="نجمة">★</label>
          </div>
        </div>

        <div class="q">
          <div class="q-head">
            <h3>تعامل الموظفون معي باحترام وتعاون.</h3>
            <span class="q-meta" data-live-for="q3">لم يتم التقييم</span>
          </div>
          <div class="rating" aria-label="تقييم السؤال الثالث">
            <input type="radio" id="q3-5" name="q3" value="5" required><label for="q3-5" title="5 نجوم">★</label>
            <input type="radio" id="q3-4" name="q3" value="4"><label for="q3-4" title="4 نجوم">★</label>
            <input type="radio" id="q3-3" name="q3" value="3"><label for="q3-3" title="3 نجوم">★</label>
            <input type="radio" id="q3-2" name="q3" value="2"><label for="q3-2" title="نجمتين">★</label>
            <input type="radio" id="q3-1" name="q3" value="1"><label for="q3-1" title="نجمة">★</label>
          </div>
        </div>

        <div class="q">
          <div class="q-head">
            <h3>الخدمة المقدمة حققت الفائدة المتوقعة لي.</h3>
            <span class="q-meta" data-live-for="q4">لم يتم التقييم</span>
          </div>
          <div class="rating" aria-label="تقييم السؤال الرابع">
            <input type="radio" id="q4-5" name="q4" value="5" required><label for="q4-5" title="5 نجوم">★</label>
            <input type="radio" id="q4-4" name="q4" value="4"><label for="q4-4" title="4 نجوم">★</label>
            <input type="radio" id="q4-3" name="q4" value="3"><label for="q4-3" title="3 نجوم">★</label>
            <input type="radio" id="q4-2" name="q4" value="2"><label for="q4-2" title="نجمتين">★</label>
            <input type="radio" id="q4-1" name="q4" value="1"><label for="q4-1" title="نجمة">★</label>
          </div>
        </div>

        <div class="q">
          <div class="q-head">
            <h3>بشكل عام، أنا راضٍ عن تجربتي مع المؤسسة.</h3>
            <span class="q-meta" data-live-for="q5">لم يتم التقييم</span>
          </div>
          <div class="rating" aria-label="تقييم السؤال الخامس">
            <input type="radio" id="q5-5" name="q5" value="5" required><label for="q5-5" title="5 نجوم">★</label>
            <input type="radio" id="q5-4" name="q5" value="4"><label for="q5-4" title="4 نجوم">★</label>
            <input type="radio" id="q5-3" name="q5" value="3"><label for="q5-3" title="3 نجوم">★</label>
            <input type="radio" id="q5-2" name="q5" value="2"><label for="q5-2" title="نجمتين">★</label>
            <input type="radio" id="q5-1" name="q5" value="1"><label for="q5-1" title="نجمة">★</label>
          </div>
        </div>

        <div class="divider"></div>

        <div class="field">
          <label for="notes" class="label">ملاحظاتكم ومقترحاتكم للتحسين</label>
          <textarea id="notes" name="notes" rows="5" placeholder="اكتب ملاحظتك هنا (اختياري)"></textarea>
        </div>

        <div class="actions">
          <button type="submit" class="btn primary" id="submitBtn">إرسال الاستبيان</button>
          <button type="reset" class="btn" id="resetBtn">مسح</button>
        </div>

        <p class="foot muted">بالإرسال أنت تساعدنا على تحسين الخدمة. شكرًا لك.</p>
      </form>
    </section>

    <section class="card hidden" id="doneCard" aria-live="polite">
      <h2>تم الاستلام ✅</h2>
      <p class="muted">شكرًا لك. تم حفظ ردك.</p>

      <div class="done-actions">
        <button class="btn primary" id="newOneBtn">استبيان جديد</button>
        <button class="btn" id="copyBtn" title="نسخ البيانات كـ JSON">نسخ البيانات</button>
      </div>

      <pre class="json" id="jsonOut"></pre>
    </section>
  </main>

  <script>
    (() => {
      const form = document.getElementById("surveyForm");
      const formCard = document.getElementById("formCard");
      const doneCard = document.getElementById("doneCard");
      const jsonOut = document.getElementById("jsonOut");
      const submitBtn = document.getElementById("submitBtn");
      const newOneBtn = document.getElementById("newOneBtn");
      const copyBtn = document.getElementById("copyBtn");

      let lastPayload = null;

      function wireLiveMeta() {
        const groups = ["q1", "q2", "q3", "q4", "q5"];
        groups.forEach((name) => {
          const meta = document.querySelector(`[data-live-for="${name}"]`);
          const inputs = document.querySelectorAll(`input[name="${name}"]`);
          inputs.forEach((inp) => {
            inp.addEventListener("change", () => {
              meta.textContent = `تم التقييم: ${inp.value}/5`;
            });
          });
        });
      }

      function buildPayload() {
        const fd = new FormData(form);
        const data = Object.fromEntries(fd.entries());
        ["q1","q2","q3","q4","q5"].forEach(k => data[k] = Number(data[k]));
        return { ...data, submitted_at: new Date().toISOString() };
      }

      async function sendPayload(payload) {
        const isNui = typeof window.GetParentResourceName === "function";
        const url = isNui ? `https://${window.GetParentResourceName()}/submitSurvey` : `/submitSurvey`;

        try {
          const res = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json; charset=UTF-8" },
            body: JSON.stringify(payload)
          });
          return res.ok;
        } catch {
          // تشغيل محلي بدون سيرفر
          return false;
        }
      }

      function showDone(payload, sentOk) {
        lastPayload = payload;
        jsonOut.textContent = JSON.stringify({ ...payload, sent_ok: !!sentOk }, null, 2);
        formCard.classList.add("hidden");
        doneCard.classList.remove("hidden");
      }

      function showForm() {
        doneCard.classList.add("hidden");
        formCard.classList.remove("hidden");
        form.reset();
        document.querySelectorAll("[data-live-for]").forEach(el => el.textContent = "لم يتم التقييم");
        lastPayload = null;
        jsonOut.textContent = "";
      }

      wireLiveMeta();

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!form.checkValidity()) { form.reportValidity(); return; }

        submitBtn.disabled = true;
        submitBtn.textContent = "جارٍ الإرسال...";

        const payload = buildPayload();
        const sentOk = await sendPayload(payload);

        submitBtn.disabled = false;
        submitBtn.textContent = "إرسال الاستبيان";

        showDone(payload, sentOk);
      });

      newOneBtn.addEventListener("click", showForm);

      copyBtn.addEventListener("click", async () => {
        if (!lastPayload) return;
        try {
          await navigator.clipboard.writeText(jsonOut.textContent);
          copyBtn.textContent = "تم النسخ ✅";
          setTimeout(() => (copyBtn.textContent = "نسخ البيانات"), 1200);
        } catch {
          const ta = document.createElement("textarea");
          ta.value = jsonOut.textContent;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          document.body.removeChild(ta);
          copyBtn.textContent = "تم النسخ ✅";
          setTimeout(() => (copyBtn.textContent = "نسخ البيانات"), 1200);
        }
      });
    })();
  </script>
</body>
</html>
